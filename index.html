import tkinter as tk
from tkinter import messagebox


class TestVisuelApp(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("FlyTest / ButterflyTest â€“ EntraÃ®nement Visuel")
        self.configure(bg="white")

        # ---------- donnÃ©es losanges ----------
        self.correct_positions = {
            1: "down",
            2: "left",
            3: "right",
            4: "up",
            5: "up",
            6: "right",
            7: "right",
            8: "left",
            9: "down",
        }
        self.selected_positions = {}
        self.diamonds = {}

        # ---------- donnÃ©es cases neutres ----------
        # bonnes rÃ©ponses : A2, B4, C3
        self.correct_boxes = {"A": 1, "B": 3, "C": 2}
        self.selected_boxes = {}
        self.box_cells = {}

        # Construire toute lâ€™interface
        self.build_ui()

    # =========================================================
    #  CONSTRUCTION INTERFACE COMPLÃˆTE
    # =========================================================
    def build_ui(self):

        # ============================
        #     BANNIÃˆRE DES TESTS
        # ============================
        banner = tk.Frame(self, bg="white")
        banner.pack(pady=(20, 20), fill="x")

        # Colonne gauche : FLYTEST
        left = tk.Frame(banner, bg="white")
        left.pack(side="left", expand=True)

        tk.Label(left, text="ðŸª°", font=("Arial", 60), bg="white").pack()
        tk.Label(
            left,
            text="FLYTEST",
            font=("Arial", 26, "bold"),
            fg="#1a73e8",
            bg="white",
        ).pack()

        # Colonne centrale
        center = tk.Frame(banner, bg="white")
        center.pack(side="left", expand=True)

        tk.Label(
            center,
            text="TEST VISUEL â€“ ENTRAÃŽNEMENT",
            font=("Arial", 26, "bold"),
            bg="white"
        ).pack(pady=5)

        # Colonne droite : BUTTERFLYTEST
        right = tk.Frame(banner, bg="white")
        right.pack(side="left", expand=True)

        tk.Label(right, text="ðŸ¦‹", font=("Arial", 60), bg="white").pack()
        tk.Label(
            right,
            text="BUTTERFLYTEST",
            font=("Arial", 26, "bold"),
            fg="#c2185b",
            bg="white",
        ).pack()

        tk.Frame(self, height=3, bg="#000000").pack(fill="x", pady=(5, 20))

        # ============================
        #     PARTIE LOSANGES
        # ============================
        frame_top = tk.Frame(self, bg="white")
        frame_top.pack(padx=10, pady=10)

        tk.Label(
            frame_top,
            text="Partie 1 â€“ Losanges",
            bg="white",
            font=("Arial", 14, "bold"),
        ).grid(row=0, column=0, columnspan=3, pady=(0, 5))

        tk.Label(
            frame_top,
            text="Clique sur la cible oÃ¹ doit se trouver le point rouge.",
            bg="white",
            font=("Arial", 10),
        ).grid(row=1, column=0, columnspan=3, pady=(0, 10))

        num = 1
        for r in range(3):
            for c in range(3):
                canvas = tk.Canvas(
                    frame_top,
                    width=90,
                    height=90,
                    bg="white",
                    highlightthickness=0
                )
                canvas.grid(row=r + 2, column=c, padx=10, pady=10)
                self.draw_diamond(canvas, num)
                num += 1

        tk.Button(
            frame_top,
            text="VÃ©rifier les losanges",
            font=("Arial", 11, "bold"),
            command=self.check_diamonds,
        ).grid(row=5, column=0, columnspan=3, pady=(5, 0))

        # Ligne de sÃ©paration
        tk.Frame(self, height=2, bg="#333333").pack(fill="x", pady=10)

        # ============================
        #   PARTIE A/B/C
        # ============================
        frame_bottom = tk.Frame(self, bg="white")
        frame_bottom.pack(padx=10, pady=(0, 10))

        tk.Label(
            frame_bottom,
            text="Partie 2 â€“ Lignes A / B / C (cases numÃ©rotÃ©es)",
            bg="white",
            font=("Arial", 14, "bold"),
        ).grid(row=0, column=0, columnspan=6, pady=(0, 10))

        CELL_SIZE = 80
        self.box_cells = {}
        row_index = 1

        for line in ["A", "B", "C"]:
            # Lettre Ã  gauche
            tk.Label(
                frame_bottom,
                text=line,
                bg="white",
                font=("Arial", 18, "bold"),
            ).grid(row=row_index, column=0, padx=10)

            self.box_cells[line] = []

            for i in range(5):
                canvas = tk.Canvas(
                    frame_bottom,
                    width=CELL_SIZE,
                    height=CELL_SIZE,
                    bg="white",
                    highlightthickness=0,
                )
                canvas.grid(row=row_index, column=i + 1, padx=8, pady=6)

                # Cadre noir
                rect = canvas.create_rectangle(
                    2, 2, CELL_SIZE - 2, CELL_SIZE - 2,
                    outline="black",
                    width=3
                )

                # Petite croix
                margin = 10
                canvas.create_line(
                    margin, margin,
                    CELL_SIZE - margin, CELL_SIZE - margin,
                    width=2
                )
                canvas.create_line(
                    CELL_SIZE - margin, margin,
                    margin, CELL_SIZE - margin,
                    width=2
                )

                # NumÃ©ro central
                canvas.create_text(
                    CELL_SIZE // 2,
                    CELL_SIZE // 2,
                    text=str(i + 1),
                    font=("Arial", 22, "bold")
                )

                # Clic
                canvas.bind(
                    "<Button-1>",
                    lambda e, L=line, idx=i: self.select_box(L, idx),
                )

                self.box_cells[line].append({"canvas": canvas, "rect": rect})

            row_index += 1

        tk.Button(
            frame_bottom,
            text="VÃ©rifier les images",
            font=("Arial", 11, "bold"),
            command=self.check_boxes,
        ).grid(row=row_index, column=0, columnspan=6, pady=(10, 0))

    # =========================================================
    #   LOSANGES : DESSIN, SÃ‰LECTION, CORRECTION
    # =========================================================
    def draw_diamond(self, canvas, number):
        w, h = 90, 90
        cx, cy = w // 2, h // 2
        size = 30

        # losange
        canvas.create_polygon(
            cx, cy - size,
            cx + size, cy,
            cx, cy + size,
            cx - size, cy,
            outline="black", fill="white", width=2,
        )

        # numÃ©ro
        canvas.create_text(cx, cy, text=str(number), font=("Arial", 11, "bold"))

        circles = {}
        positions = {
            "up":    (cx, cy - size + 10),
            "right": (cx + size - 10, cy),
            "down":  (cx, cy + size - 10),
            "left":  (cx - size + 10, cy),
        }

        for pos_name, (x, y) in positions.items():
            outer_r = 9
            inner_r = 4

            outer = canvas.create_oval(
                x - outer_r, y - outer_r,
                x + outer_r, y + outer_r,
                outline="black", width=2, fill="white",
            )
            inner = canvas.create_oval(
                x - inner_r, y - inner_r,
                x + inner_r, y + inner_r,
                outline="black", width=1, fill="white",
            )

            canvas.tag_bind(
                outer,
                "<Button-1>",
                lambda e, n=number, p=pos_name: self.select_diamond(n, p),
            )
            canvas.tag_bind(
                inner,
                "<Button-1>",
                lambda e, n=number, p=pos_name: self.select_diamond(n, p),
            )

            circles[pos_name] = (outer, inner)

        self.diamonds[number] = {"canvas": canvas, "circles": circles}

    def select_diamond(self, number, position):
        self.selected_positions[number] = position
        data = self.diamonds[number]
        canvas = data["canvas"]
        circles = data["circles"]

        # reset
        for outer, inner in circles.values():
            canvas.itemconfig(outer, outline="black", width=2)
            canvas.itemconfig(inner, fill="white")

        outer, inner = circles[position]
        canvas.itemconfig(outer, outline="blue", width=3)
        canvas.itemconfig(inner, fill="#a5c8ff")

    def check_diamonds(self):
        total = len(self.correct_positions)
        correct = 0

        # reset visuel
        for data in self.diamonds.values():
            for outer, inner in data["circles"].values():
                data["canvas"].itemconfig(outer, outline="black", width=2)
                data["canvas"].itemconfig(inner, fill="white")

        for n, good_pos in self.correct_positions.items():
            data = self.diamonds[n]
            circles = data["circles"]
            canvas = data["canvas"]
            user_pos = self.selected_positions.get(n)

            good_outer, good_inner = circles[good_pos]
            canvas.itemconfig(good_outer, outline="green", width=3)
            canvas.itemconfig(good_inner, fill="#9df59d")

            if user_pos == good_pos:
                correct += 1
            elif user_pos is not None:
                bad_outer, bad_inner = circles[user_pos]
                canvas.itemconfig(bad_outer, outline="red", width=3)
                canvas.itemconfig(bad_inner, fill="#ffb3b3")

        messagebox.showinfo("RÃ©sultat â€“ losanges", f"Score : {correct} / {total}")

    # =========================================================
    #   CASES A/B/C : SÃ‰LECTION & CORRECTION
    # =========================================================
    def select_box(self, line, index):
        self.selected_boxes[line] = index

        for i, cell in enumerate(self.box_cells[line]):
            canvas = cell["canvas"]
            rect = cell["rect"]
            if i == index:
                canvas.itemconfig(rect, outline="blue", width=3, fill="#dde9ff")
            else:
                canvas.itemconfig(rect, outline="black", width=3, fill="white")

    def check_boxes(self):
        total = len(self.correct_boxes)
        correct = 0

        # reset
        for line, cells in self.box_cells.items():
            for cell in cells:
                cell["canvas"].itemconfig(
                    cell["rect"], outline="black", width=3, fill="white"
                )

        for line, good_idx in self.correct_boxes.items():
            cells = self.box_cells[line]

            # bonne rÃ©ponse en vert
            good_cell = cells[good_idx]
            good_canvas = good_cell["canvas"]
            good_rect = good_cell["rect"]
            good_canvas.itemconfig(good_rect, outline="green", width=3, fill="#9df59d")

            chosen = self.selected_boxes.get(line)

            if chosen == good_idx:
                correct += 1
            elif chosen is not None:
                bad_cell = cells[chosen]
                bad_canvas = bad_cell["canvas"]
                bad_rect = bad_cell["rect"]
                bad_canvas.itemconfig(bad_rect, outline="red", width=3, fill="#ffb3b3")

        messagebox.showinfo("RÃ©sultat â€“ images", f"Score : {correct} / {total}")


if __name__ == "__main__":
    app = TestVisuelApp()
    app.mainloop()

